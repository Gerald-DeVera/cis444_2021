<!DOCTYPE html>
<html>
    <head>
	     <script src="https://code.jquery.com/jquery-3.6.0.js" 
		     integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
	     <script src="/static/cis444.js"></script>
		 <script src="https://maps.google.com/maps/api/js?sensor=false"></script>
    </head>
	<title>My website!</title>

    <body>
	
	<script>
		
		var curUser;

		function send_form(){
			console.log("I am in send form");
			curUser = document.getElementById("fname").value;
			//console.log(curUser);
			$.post("/open_api/login", { "firstname":$('#fname').val(), "password":$('#password').val()},
                       		function(data, textStatus) {
					//this gets called when browser receives response from server
					console.log(data.token);
					//Set global JWT
					jwt = data.token;
					console.log("this is jwt");
					console.log(jwt);
					//make secure call with the jwt
					//get_books();
					$('#login').hide();
				}, "json").fail( function(response) {
					//this gets called if the server throws an error
					console.log("error");
					console.log(response);
				});
			return false;
		}

		function get_books(){
			 //make secure call with the jwt
			secure_get_with_token("/secure_api/get_books", {} , function(data){
					console.log("got books"); 
					console.log(data.booksName[1]); 
					$('#login').hide();
					$('#books').show();

					for(var i = 0; i < data.booksName.length; i++){
							$('#bookList').append($('<option>',{
								value: data.booksName[i],
								text: 'Title: ' + data.booksName[i] + ' Price: $' + data.booksPrice[i]
							}));
						}

					},
                                                function(err){ console.log(err) });
		}

        function buy_book(){
						var e = document.getElementById('bookList');
						var book_id = e.options[e.selectedIndex].value;
						console.log(book_id)
						console.log(curUser)
                    	//make secure call with the jwt
                        secure_post_with_token("/secure_api/buy_book", {"book_id" : book_id, "userName" : curUser} , function(data){console.log("got books"); console.log(data)},
                                                function(err){ console.log(err) });

						alert("Thank you for your purchase")
                }

		function addUserForm(){
				console.log("I AM IN ADDUSERFORM")
				$('#login').hide();
				$('#addNewUser').show();
				//newUserConfirm();
				}

		function newUserConfirm(){
				console.log("I AM IN NEW USER CONFIRM")
				$.post("/open_api/createUser", { "firstname":$('#newUName').val(), "password":$('#newPass').val()},
                       		function(data, textStatus) {
					//this gets called when browser receives response from server
					console.log(data);
					console.log(data._status_);
					x = data._status_.toString() + ": " + data.message.toString();
					$('#login').show();
					$('#addNewUser').hide();

					//if(x == "Good" || 'Good')
						alert(x);
					//else
					//	alert("User already exists.")
				}, "json").fail( function(response) {
					//this gets called if the server throws an error
					console.log("error");
					console.log(response);
				});
			return false;
				}

		function getCoords() {
			var paragraph = document.getElementById('demo');	
			if (navigator.geolocation) {
 			   navigator.geolocation.getCurrentPosition(showPosition);
 			} else {
  				paragraph.innerHTML = "Geolocation is not supported by this browser.";
  			}
		}

		function showPosition(position){
			var paragraph = document.getElementById('demo');	
			paragraph.innerHTML = "Latitude: " + position.coords.latitude + "<br>Longitude: " + position.coords.longitude;
		}

		function showMap(){
			console.log("In show Map");
			navigator.geolocation.getCurrentPosition(createMap);
		}

		function createMap(position){
			console.log("In create Map");
			//Location Data
			//var latlong = position.coords.latitude + "," + position.coords.longitude;
			$('#embedMap').show();
			var lat = position.coords.latitude;
			var long = position.coords.longitude;

			var latlong = new google.maps.LatLng(lat, long);
			
			var myOptions = {
				center: latlong,
				zoom: 16,
				mapTypeControlOptions: {
            		style:google.maps.NavigationControlStyle.SMALL
        		}
			}
			var map = new google.maps.Map(document.getElementById("embedMap"), myOptions);
			var marker = new google.maps.Marker({ position:latlong, map:map, title:"You are here!" });

			//var mapLink = "https://maps.googleapis.com/maps/api/staticmap?center="+latlong+"&zoom=16&size=400x300&output=embed";

			//create and insert map
			//document.getElementById("embedMap").innerHTML = "<img alt='Map Holder' src='"+ mapLink +"'>";
		}
	</script>
        <div id="login">
	    	<form >
  			<label for="fname">First name:</label><br>
  				<input type="text" id="fname" name="fname" value="John"><br>
  			<label for="password">Password:</label><br>
  				<input type="password" id="password" name="password" value="Doe"><br><br>
  			<input type="submit" value="Login" onclick="return send_form();">
			<input type="button" value="Create New User" onclick="return addUserForm();">
			</form>
	    </div>

		<p id="demo" onclick="getCoords()">Click me to show location.</p>

			<div id="addNewUser" style = "display:none">
				<form >
				<label for="uname">New Username:</label><br>
					<input type="text" id="newUName" name="newUName" value="John"><br>
				<label for="pass">New Password:</label><br>
					<input type="password" id="newPass" name="newPass" value="Doe"><br><br>
				<input type="submit" value="Submit" onclick="return newUserConfirm();">
			</form>
		</div>

		<button type="button" onclick="showMap()">Open Google Map</button>

		<div id="embedMap" style=" width: 400px; height: 300px;" >
		</div>


<!--		<iframe width="600" height="450" style="border:0" loading="lazy" allowfullscreen
		src="https://www.google.com/maps/embed/v1/view?zoom=17&center=33.1518,-117.1121&key=AIzaSyCqHsEvaX5va8GXURbX4K1qigwpvPWVVW0"></iframe>-->


		<!--<div id="books" style="display:none">
			<form id="bookDisplay">
				<h1>Buy me</h1>
				<select name="bookList" id="bookList"></select><br>
				<input type="button" value="Purchase Book" id="purchaseButton" onclick="return buy_book();">	
			</form>
		</div>-->
	    <!--<button id="buybook" onclick="buy_book(1234)" style="display:none" >Buy Book</button>-->
    </body>
</html>

